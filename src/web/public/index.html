<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ§‹é€ çš„å¯¾è©±ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 24px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .main {
            padding: 32px;
        }
        
        .input-section {
            margin-bottom: 32px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.2s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #4f46e5;
        }
        
        .controls {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #4f46e5;
            color: white;
        }
        
        .btn-primary:hover {
            background: #4338ca;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .settings-toggle {
            margin-left: auto;
        }
        
        .settings {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .settings.open {
            display: block;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .setting-item {
            display: flex;
            flex-direction: column;
        }
        
        .setting-item label {
            font-size: 12px;
            text-transform: uppercase;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .setting-item input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }
        
        .results {
            margin-top: 32px;
            display: none;
        }
        
        .results.show {
            display: block;
        }
        
        .summary {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #059669;
        }
        
        .summary-label {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .chunk {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        
        .chunk-header {
            background: #f9fafb;
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chunk-title {
            font-weight: 600;
            color: #374151;
        }
        
        .chunk-meta {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .chunk-content {
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .chunk-content pre {
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #dc2626;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .copy-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 12px;
            transition: background-color 0.2s;
        }
        
        .copy-btn:hover {
            background: #2563eb;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§© æ§‹é€ çš„å¯¾è©±ãƒ„ãƒ¼ãƒ«</h1>
            <p>AIã¨ã®å¯¾è©±ãƒ­ã‚°ã‚’è‡ªå‹•åˆ†å‰²ãƒ»å‘½åãƒ»æ›¸å¼çµ±ä¸€</p>
        </div>
        
        <div class="main">
            <div class="input-section">
                <div class="form-group">
                    <label for="rawLog">ğŸ—£ï¸ ç”Ÿãƒ­ã‚°ï¼ˆAIã¨ã®å¯¾è©±ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ï¼‰</label>
                    <textarea 
                        id="rawLog" 
                        placeholder="User: ã“ã‚“ã«ã¡ã¯&#10;&#10;Assistant: ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ&#10;&#10;User: æ§‹é€ çš„å¯¾è©±ã«ã¤ã„ã¦æ•™ãˆã¦..."
                    ></textarea>
                </div>
                
                <div class="form-group">
                    <label for="sessionContext">ğŸ”— ã‚»ãƒƒã‚·ãƒ§ãƒ³æ–‡è„ˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                    <textarea 
                        id="sessionContext" 
                        style="min-height: 100px;"
                        placeholder="ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®èƒŒæ™¯æƒ…å ±ã€å‰å›ã‹ã‚‰ã®ç¶™ç¶šäº‹é …ãªã©..."
                    ></textarea>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="processUnified()">
                        âœ¨ çµ±ä¸€å‡¦ç†ï¼ˆæ¨å¥¨ï¼‰
                    </button>
                    <button class="btn btn-secondary" onclick="processLog()">
                        ğŸš€ å¾“æ¥å‡¦ç†
                    </button>
                    <button class="btn btn-secondary" onclick="extractConcepts()">
                        ğŸ§  æ¦‚å¿µæŠ½å‡º
                    </button>
                    <button class="btn btn-secondary" onclick="clearAll()">
                        ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                    </button>
                    <button class="btn btn-secondary settings-toggle" onclick="toggleSettings()">
                        âš™ï¸ è¨­å®š
                    </button>
                </div>
                
                <!-- NEW: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                <div class="session-controls" style="margin-top: 20px; padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                    <h3 style="color: #0c4a6e; margin-bottom: 12px;">ğŸ’¾ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†</h3>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                        <button class="btn btn-primary" onclick="saveCurrentSession()" id="saveSessionBtn">
                            ğŸ’¾ ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
                        </button>
                        <button class="btn btn-secondary" onclick="startNewSession()" id="startNewBtn">
                            ğŸ”— å‰å›ã‹ã‚‰ç¶™ç¶šé–‹å§‹
                        </button>
                        <button class="btn btn-secondary" onclick="showSessionDashboard()" id="dashboardBtn">
                            ğŸ“Š ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
                        </button>
                        <button class="btn btn-secondary" onclick="getLatestHandover()" id="handoverBtn">
                            ğŸ”„ å¼•ãç¶™ãç¢ºèª
                        </button>
                    </div>
                    <div id="sessionStatus" style="margin-top: 12px; font-size: 14px; color: #6b7280;"></div>
                </div>
                
                <div class="settings" id="settings">
                    <h3>âš™ï¸ å‡¦ç†è¨­å®š</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>ç›®æ¨™ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚º</label>
                            <input type="number" id="targetChunkSize" value="10000" min="1000" max="50000">
                        </div>
                        <div class="setting-item">
                            <label>æ–‡è„ˆä¿æŒ</label>
                            <input type="checkbox" id="preserveContext" checked>
                        </div>
                        <div class="setting-item">
                            <label>ãƒãƒ£ãƒ³ã‚¯ãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ </label>
                            <input type="checkbox" id="addChunkHeaders" checked>
                        </div>
                        <div class="setting-item">
                            <label>ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ</label>
                            <input type="checkbox" id="generateFilenames" checked>
                        </div>
                        <div class="setting-item">
                            <label>æ›¸å¼çµ±ä¸€</label>
                            <input type="checkbox" id="unifyFormat" checked>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ãƒ­ã‚°ã‚’å‡¦ç†ä¸­...</p>
            </div>
            
            <div class="error" id="error"></div>
            
            <div class="results" id="results">
                <div class="summary" id="summary"></div>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('chunks')">ğŸ“¦ åˆ†å‰²çµæœ</div>
                    <div class="tab" onclick="switchTab('prompts')">ğŸ’¬ æ§‹é€ åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</div>
                    <div class="tab" onclick="switchTab('unified')">âœ¨ çµ±ä¸€æ›¸å¼</div>
                    <div class="tab" onclick="switchTab('concepts')">ğŸ§  æ¦‚å¿µæŠ½å‡º</div>
                    <div class="tab" onclick="switchTab('metrics')">ğŸ“Š å“è³ªåˆ†æ</div>
                    <div class="tab" onclick="switchTab('sessions')">ğŸ’¾ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†</div>
                </div>
                
                <div class="tab-content active" id="chunks-content"></div>
                <div class="tab-content" id="prompts-content"></div>
                <div class="tab-content" id="unified-content"></div>
                <div class="tab-content" id="concepts-content"></div>
                <div class="tab-content" id="metrics-content"></div>
                <div class="tab-content" id="sessions-content"></div>
            </div>
        </div>
    </div>

    <script>
        let currentResults = null;

        function toggleSettings() {
            const settings = document.getElementById('settings');
            settings.classList.toggle('open');
        }

        function clearAll() {
            document.getElementById('rawLog').value = '';
            document.getElementById('sessionContext').value = '';
            document.getElementById('results').classList.remove('show');
            document.getElementById('error').classList.remove('show');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-content').classList.add('active');
        }

        async function processUnified() {
            const rawLog = document.getElementById('rawLog').value.trim();
            const sessionContext = document.getElementById('sessionContext').value.trim();
            
            if (!rawLog) {
                showError('ç”Ÿãƒ­ã‚°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showLoading(true);
            hideError();

            try {
                const response = await fetch('/api/process-unified', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rawLog,
                        sessionContext: sessionContext || undefined
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentResults = result;
                    displayUnifiedResults(result);
                } else {
                    showError(result.error || 'å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            } catch (error) {
                showError('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function processLog() {
            const rawLog = document.getElementById('rawLog').value.trim();
            const sessionContext = document.getElementById('sessionContext').value.trim();
            
            if (!rawLog) {
                showError('ç”Ÿãƒ­ã‚°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const options = {
                targetChunkSize: parseInt(document.getElementById('targetChunkSize').value),
                preserveContext: document.getElementById('preserveContext').checked,
                addChunkHeaders: document.getElementById('addChunkHeaders').checked,
                generateFilenames: document.getElementById('generateFilenames').checked,
                unifyFormat: document.getElementById('unifyFormat').checked
            };

            showLoading(true);
            hideError();

            try {
                const response = await fetch('/api/process-log', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rawLog,
                        sessionContext: sessionContext || undefined,
                        options
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentResults = result;
                    displayResults(result);
                } else {
                    showError(result.error || 'å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            } catch (error) {
                showError('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayUnifiedResults(result) {
            const summary = document.getElementById('summary');
            summary.innerHTML = `
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-value">${result.summary.originalLength.toLocaleString()}</div>
                        <div class="summary-label">å…ƒã®æ–‡å­—æ•°</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${result.summary.chunkCount}</div>
                        <div class="summary-label">ãƒãƒ£ãƒ³ã‚¯æ•°</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${result.summary.processingTime}ms</div>
                        <div class="summary-label">å‡¦ç†æ™‚é–“</div>
                    </div>
                    <div class="summary-item unified-feature">
                        <div class="summary-value">âœ¨</div>
                        <div class="summary-label">çµ±ä¸€å‡¦ç†</div>
                    </div>
                </div>
                
                <div class="unified-header" style="margin-top: 20px; padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                    <h3 style="color: #0c4a6e; margin-bottom: 12px;">ğŸ“‹ ${result.unified.header.title}</h3>
                    <p><strong>ä¸»è¦æ¦‚å¿µ:</strong> ${result.unified.header.mainConcepts.join(', ')}</p>
                    <p><strong>è­°è«–ç¯„å›²:</strong> ${result.unified.header.discussionScope}</p>
                    <p><strong>å¯¾è©±å½¢å¼:</strong> ${result.unified.header.dialogueType}</p>
                    <p><strong>æ¨å¥¨ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${result.unified.header.suggestedFilename}</p>
                </div>
            `;

            const chunksContent = document.getElementById('chunks-content');
            chunksContent.innerHTML = result.unified.chunks.map((chunk, index) => `
                <div class="chunk">
                    <div class="chunk-header">
                        <div class="chunk-title">ãƒãƒ£ãƒ³ã‚¯ ${chunk.index}/${result.summary.chunkCount}</div>
                        <div class="chunk-meta">
                            æ–‡å­—ç¯„å›²: ${chunk.characterRange}
                            <button class="copy-btn" onclick="copyToClipboard(\`${chunk.continuationPrompt.replace(/`/g, '\\`')}\`, this)">
                                ğŸš€ AIã«é€ä¿¡ï¼ˆå®Œå…¨ç‰ˆï¼‰
                            </button>
                        </div>
                    </div>
                    <div class="chunk-content">
                        <h4>ğŸ¯ AIé€ä¿¡ç”¨å®Œå…¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæŒ‡ç¤º + å®Ÿéš›ã®ãƒ­ã‚°å†…å®¹ï¼‰</h4>
                        <p style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">
                            ã€ŒğŸš€ AIã«é€ä¿¡ï¼ˆå®Œå…¨ç‰ˆï¼‰ã€ãƒœã‚¿ãƒ³ã§ã€ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’Claude/ChatGPTã«ç›´æ¥è²¼ã‚Šä»˜ã‘ã¦æ§‹é€ åŒ–ã§ãã¾ã™
                        </p>
                        <pre style="max-height: 300px; overflow-y: auto;">${escapeHtml(chunk.continuationPrompt)}</pre>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
                            <h4>ğŸ“„ åˆ†å‰²å¾Œã®åŸæ–‡ï¼ˆå‚è€ƒç”¨ï¼‰</h4>
                            <button class="copy-btn btn-secondary" onclick="copyToClipboard(\`${chunk.content.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`, this)" style="background: #6b7280;">
                                ğŸ“„ åŸæ–‡ã®ã¿ã‚³ãƒ”ãƒ¼
                            </button>
                        </div>
                        <pre style="max-height: 400px; overflow-y: auto; background: #f8f9fa; white-space: pre-wrap;">${escapeHtml(chunk.content)}</pre>
                    </div>
                </div>
            `).join('');

            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¿ãƒ–ã«çµ±ä¸€å‡ºåŠ›ã‚’è¡¨ç¤º
            const promptsContent = document.getElementById('prompts-content');
            promptsContent.innerHTML = `
                <div style="margin-bottom: 20px; padding: 16px; background: #ecfdf5; border-radius: 8px;">
                    <h3 style="color: #065f46;">ğŸš€ ç°¡å˜3ã‚¹ãƒ†ãƒƒãƒ—ã§æ§‹é€ åŒ–</h3>
                    <ol style="margin: 12px 0; padding-left: 20px;">
                        <li>å„ãƒãƒ£ãƒ³ã‚¯ã®ã€ŒğŸš€ AIã«é€ä¿¡ï¼ˆå®Œå…¨ç‰ˆï¼‰ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>Claude/ChatGPTã«è²¼ã‚Šä»˜ã‘ã¦ã‚¨ãƒ³ã‚¿ãƒ¼</li>
                        <li>æ§‹é€ åŒ–å®Œäº†ï¼</li>
                    </ol>
                    <p style="color: #065f46; font-weight: 500;">â€» ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã¯æŒ‡ç¤º + å®Ÿéš›ã®ãƒ­ã‚°å†…å®¹ãŒå«ã¾ã‚Œã¦ã„ã¾ã™</p>
                </div>
                <pre style="white-space: pre-wrap; font-size: 13px; line-height: 1.5;">${escapeHtml(result.unified.output)}</pre>
            `;

            // çµ±ä¸€æ›¸å¼ã‚¿ãƒ–ã«çµ±ä¸€å‡ºåŠ›ã‚’è¡¨ç¤º
            const unifiedContent = document.getElementById('unified-content');
            unifiedContent.innerHTML = `
                <div style="margin-bottom: 20px; padding: 16px; background: #fef3c7; border-radius: 8px;">
                    <h3 style="color: #92400e;">ğŸ“ æ¨å¥¨ãƒ•ã‚¡ã‚¤ãƒ«å: ${result.unified.header.suggestedFilename}</h3>
                    <p>çµ±ä¸€å‡¦ç†ã«ã‚ˆã‚Šã€ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§å…¨ä½“ã‚’ç®¡ç†ã§ãã¾ã™ã€‚</p>
                </div>
                <pre style="white-space: pre-wrap; font-size: 13px; line-height: 1.5;">${escapeHtml(result.unified.output)}</pre>
            `;

            // å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚¿ãƒ–ã«å“è³ªåˆ†æçµæœã‚’è¡¨ç¤º
            const metricsContent = document.getElementById('metrics-content');
            if (result.unified.qualityMetrics) {
                const metrics = result.unified.qualityMetrics;
                metricsContent.innerHTML = `
                    <div style="margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 12px; border-left: 4px solid #0ea5e9;">
                        <h2 style="color: #0c4a6e; margin-bottom: 16px; display: flex; align-items: center;">
                            ğŸ“Š å“è³ªåˆ†æãƒ¬ãƒãƒ¼ãƒˆ
                            <span style="margin-left: auto; font-size: 1.8rem; font-weight: bold; color: ${getScoreColor(metrics.overallScore)};">
                                ${metrics.overallScore.toFixed(1)}/100
                            </span>
                        </h2>
                        <p style="color: #075985; margin-bottom: 0;">çµ±ä¸€ãƒ­ã‚°å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã®åŠ¹æœã‚’å®šé‡çš„ã«åˆ†æ</p>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
                        <!-- æ¦‚å¿µæ¤œå‡ºèƒ½åŠ› -->
                        <div style="background: #ecfdf5; border: 1px solid #10b981; border-radius: 8px; padding: 16px;">
                            <h3 style="color: #065f46; margin-bottom: 12px;">ğŸ” æ¦‚å¿µæ¤œå‡ºèƒ½åŠ›</h3>
                            <div style="space-y: 8px;">
                                <div><strong>æ¤œå‡ºæ¦‚å¿µæ•°:</strong> ${metrics.conceptDetection.detectedConceptsCount}å€‹</div>
                                <div><strong>æ¦‚å¿µå¯†åº¦:</strong> ${metrics.conceptDetection.conceptDensity.toFixed(3)}/ä¸‡æ–‡å­—</div>
                                <div><strong>æ¦‚å¿µã‚«ãƒãƒ¬ãƒƒã‚¸:</strong> ${metrics.conceptDetection.conceptCoverage.toFixed(1)}%</div>
                                <div><strong>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒç‡:</strong> ${metrics.conceptDetection.keywordMatchRate.toFixed(1)}%</div>
                                <div><strong>æ¦‚å¿µä¸€è²«æ€§:</strong> ${metrics.conceptDetection.conceptCoherence.toFixed(1)}%</div>
                            </div>
                        </div>

                        <!-- å‡¦ç†æ€§èƒ½ -->
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px;">
                            <h3 style="color: #92400e; margin-bottom: 12px;">âš¡ å‡¦ç†æ€§èƒ½</h3>
                            <div style="space-y: 8px;">
                                <div><strong>ç·å‡¦ç†æ™‚é–“:</strong> ${metrics.processingPerformance.totalProcessingTime}ms</div>
                                <div><strong>ãƒãƒ£ãƒ³ã‚¯å‡¦ç†æ™‚é–“:</strong> ${metrics.processingPerformance.chunkProcessingTime}ms</div>
                                <div><strong>æ¦‚å¿µæŠ½å‡ºæ™‚é–“:</strong> ${metrics.processingPerformance.conceptExtractionTime}ms</div>
                                <div><strong>ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡:</strong> ${metrics.processingPerformance.memoryUsage.toFixed(2)}MB</div>
                                <div><strong>ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ:</strong> ${metrics.processingPerformance.throughput.toFixed(0)}æ–‡å­—/ç§’</div>
                            </div>
                        </div>

                        <!-- æ§‹é€ å“è³ª -->
                        <div style="background: #fdf2f8; border: 1px solid #ec4899; border-radius: 8px; padding: 16px;">
                            <h3 style="color: #831843; margin-bottom: 12px;">ğŸ—ï¸ æ§‹é€ å“è³ª</h3>
                            <div style="space-y: 8px;">
                                <div><strong>ãƒãƒ£ãƒ³ã‚¯ãƒãƒ©ãƒ³ã‚¹:</strong> ${metrics.structuralQuality.chunkBalanceScore.toFixed(1)}%</div>
                                <div><strong>æ–‡è„ˆä¿æŒ:</strong> ${metrics.structuralQuality.contextPreservationScore.toFixed(1)}%</div>
                                <div><strong>ãƒãƒ£ãƒ³ã‚¯ä¸€è²«æ€§:</strong> ${metrics.structuralQuality.chunkCoherenceScore.toFixed(1)}%</div>
                                <div><strong>ãƒ˜ãƒƒãƒ€ãƒ¼ç²¾åº¦:</strong> ${metrics.structuralQuality.headerAccuracy.toFixed(1)}%</div>
                                <div><strong>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Œå…¨æ€§:</strong> ${metrics.structuralQuality.promptCompleteness.toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>

                    <div style="background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 8px; padding: 16px;">
                        <h3 style="color: #334155; margin-bottom: 12px;">ğŸ“ˆ ã‚¹ã‚³ã‚¢è©•ä¾¡åŸºæº–</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; text-align: center;">
                            <div style="padding: 8px; background: #dcfce7; border-radius: 6px; color: #166534;">
                                <strong>85+</strong><br>å„ªç§€
                            </div>
                            <div style="padding: 8px; background: #fef3c7; border-radius: 6px; color: #92400e;">
                                <strong>70-84</strong><br>è‰¯å¥½
                            </div>
                            <div style="padding: 8px; background: #fed7d7; border-radius: 6px; color: #b91c1c;">
                                <strong>50-69</strong><br>æ”¹å–„è¦
                            </div>
                            <div style="padding: 8px; background: #f1f5f9; border-radius: 6px; color: #475569;">
                                <strong>50æœªæº€</strong><br>è¦è¦‹ç›´ã—
                            </div>
                        </div>
                    </div>
                `;
            } else {
                metricsContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <h3>å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“</h3>
                        <p>çµ±ä¸€å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰å“è³ªåˆ†æã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p>
                    </div>
                `;
            }

            // æ¦‚å¿µæŠ½å‡ºçµæœã‚’è¡¨ç¤º
            if (result.extraction) {
                displayConceptResults(result);
            }

            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function displayResults(result) {
            const summary = document.getElementById('summary');
            summary.innerHTML = `
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-value">${result.summary.originalLength.toLocaleString()}</div>
                        <div class="summary-label">å…ƒã®æ–‡å­—æ•°</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${result.summary.chunkCount}</div>
                        <div class="summary-label">ãƒãƒ£ãƒ³ã‚¯æ•°</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${result.summary.avgChunkSize.toLocaleString()}</div>
                        <div class="summary-label">å¹³å‡ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚º</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${result.summary.processingTime}ms</div>
                        <div class="summary-label">å‡¦ç†æ™‚é–“</div>
                    </div>
                </div>
            `;

            const chunksContent = document.getElementById('chunks-content');
            chunksContent.innerHTML = result.chunks.map(chunk => `
                <div class="chunk">
                    <div class="chunk-header">
                        <div class="chunk-title">ãƒãƒ£ãƒ³ã‚¯ ${chunk.index}</div>
                        <div class="chunk-meta">
                            ${chunk.metadata.characterCount}æ–‡å­— | 
                            ${chunk.suggestedFilename || 'ãƒ•ã‚¡ã‚¤ãƒ«åæœªç”Ÿæˆ'}
                        </div>
                    </div>
                    <div class="chunk-content">
                        <pre>${escapeHtml(chunk.content.substring(0, 1000))}${chunk.content.length > 1000 ? '...' : ''}</pre>
                    </div>
                </div>
            `).join('');

            document.getElementById('results').classList.add('show');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function hideError() {
            document.getElementById('error').classList.remove('show');
        }

        function copyToClipboard(text, element) {
            try {
                // elementãŒæ¸¡ã•ã‚Œãªã„å ´åˆã¯event.targetã‚’ä½¿ç”¨ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
                const button = element || (typeof event !== 'undefined' ? event.target : null);
                
                if (!navigator.clipboard) {
                    throw new Error('Clipboard API not supported');
                }
                
                navigator.clipboard.writeText(text).then(() => {
                    if (button) {
                        // ä¸€æ™‚çš„ã«æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                        const originalText = button.textContent;
                        button.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†';
                        button.style.background = '#10b981';
                        setTimeout(() => {
                            button.textContent = originalText;
                            button.style.background = '';
                        }, 2000);
                    }
                }).catch(err => {
                    console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
                    showError('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                });
            } catch (err) {
                console.error('ã‚³ãƒ”ãƒ¼é–¢æ•°ã‚¨ãƒ©ãƒ¼:', err);
                showError('ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“: ' + err.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getScoreColor(score) {
            if (score >= 85) return '#059669'; // ç·‘ï¼ˆå„ªç§€ï¼‰
            if (score >= 70) return '#d97706'; // ã‚ªãƒ¬ãƒ³ã‚¸ï¼ˆè‰¯å¥½ï¼‰
            if (score >= 50) return '#dc2626'; // èµ¤ï¼ˆæ”¹å–„è¦ï¼‰
            return '#6b7280'; // ã‚°ãƒ¬ãƒ¼ï¼ˆè¦è¦‹ç›´ã—ï¼‰
        }

        // IntelligentConceptExtractor æ¦‚å¿µæŠ½å‡ºæ©Ÿèƒ½
        async function extractConcepts() {
            const rawLog = document.getElementById('rawLog').value.trim();
            
            if (!rawLog) {
                showError('ç”Ÿãƒ­ã‚°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showLoading(true);
            hideError();

            try {
                const response = await fetch('/api/extract-concepts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        logContent: rawLog
                    })
                });

                const result = await response.json();

                if (result.success) {
                    displayConceptResults(result);
                } else {
                    showError(result.error || 'æ¦‚å¿µæŠ½å‡ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            } catch (error) {
                showError('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayConceptResults(result) {
            const extraction = result.extraction;
            
            // ã‚µãƒãƒªãƒ¼æ›´æ–°
            const summary = document.getElementById('summary');
            summary.innerHTML = `
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-value">${result.summary.originalLength.toLocaleString()}</div>
                        <div class="summary-label">å…ƒã®æ–‡å­—æ•°</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" style="color: ${getInnovationColor(extraction.predictedInnovationLevel)};">
                            ${extraction.predictedInnovationLevel}/10
                        </div>
                        <div class="summary-label">é©æ–°åº¦äºˆæ¸¬</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${extraction.predictedSocialImpact.toUpperCase()}</div>
                        <div class="summary-label">ç¤¾ä¼šçš„ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${result.summary.processingTime}ms</div>
                        <div class="summary-label">å‡¦ç†æ™‚é–“</div>
                    </div>
                </div>
            `;

            // æ¦‚å¿µæŠ½å‡ºçµæœã‚¿ãƒ–ã«è©³ç´°ã‚’è¡¨ç¤º
            const conceptsContent = document.getElementById('concepts-content');
            conceptsContent.innerHTML = `
                <div style="margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 12px;">
                    <h2 style="color: #0c4a6e; margin-bottom: 16px; display: flex; align-items: center;">
                        ğŸ§  IntelligentConceptExtractor v2.0 çµæœ
                        <span style="margin-left: auto; font-size: 1.8rem; font-weight: bold; color: ${getInnovationColor(extraction.predictedInnovationLevel)};">
                            é©æ–°åº¦ ${extraction.predictedInnovationLevel}/10
                        </span>
                    </h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div><strong>å¯¾è©±ã‚¿ã‚¤ãƒ—:</strong> ${extraction.dialogueTypeDetection}</div>
                        <div><strong>ç¤¾ä¼šçš„ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ:</strong> ${extraction.predictedSocialImpact}</div>
                        <div><strong>çªç ´ç¢ºç‡:</strong> ${extraction.breakthroughProbability}%</div>
                        <div><strong>ä¿¡é ¼åº¦:</strong> ${extraction.confidence}%</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 24px;">
                    <!-- æ·±å±¤æ¦‚å¿µ -->
                    <div style="background: #fdf2f8; border: 1px solid #ec4899; border-radius: 8px; padding: 16px;">
                        <h3 style="color: #831843; margin-bottom: 12px;">ğŸŒŠ æ·±å±¤æ¦‚å¿µ (${extraction.deepConcepts.length}å€‹)</h3>
                        ${extraction.deepConcepts.map(concept => `
                            <div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #ec4899;">
                                <strong>${concept.term}</strong>
                                <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                    ä¿¡é ¼åº¦: ${Math.round(concept.confidence * 100)}% | ${concept.reasoning}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- è¡¨é¢æ¦‚å¿µ -->
                    <div style="background: #ecfdf5; border: 1px solid #10b981; border-radius: 8px; padding: 16px;">
                        <h3 style="color: #065f46; margin-bottom: 12px;">ğŸŒ¸ è¡¨é¢æ¦‚å¿µ (${extraction.surfaceConcepts.length}å€‹)</h3>
                        ${extraction.surfaceConcepts.map(concept => `
                            <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #10b981;">
                                <strong>${concept.term}</strong>
                                <span style="font-size: 12px; color: #6b7280; margin-left: 8px;">
                                    (${Math.round(concept.confidence * 100)}%)
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                ${extraction.timeRevolutionMarkers.length > 0 ? `
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <h3 style="color: #92400e; margin-bottom: 12px;">âš¡ æ™‚é–“é©å‘½ãƒãƒ¼ã‚«ãƒ¼ (${extraction.timeRevolutionMarkers.length}å€‹)</h3>
                        ${extraction.timeRevolutionMarkers.map(marker => `
                            <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <strong>"${marker.timeExpression}"</strong> - ${marker.efficiency}
                                <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                    ${marker.context.substring(0, 100)}...
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <div style="background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 8px; padding: 16px;">
                    <h3 style="color: #334155; margin-bottom: 12px;">ğŸ“Š å“è³ªäºˆæ¸¬</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #059669;">${extraction.qualityPrediction.conceptDensity}%</div>
                            <div style="font-size: 12px; color: #6b7280;">æ¦‚å¿µå¯†åº¦</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #d97706;">${extraction.qualityPrediction.innovationPotential}%</div>
                            <div style="font-size: 12px; color: #6b7280;">é©æ–°ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #7c3aed;">${extraction.qualityPrediction.structuralDialogueScore}%</div>
                            <div style="font-size: 12px; color: #6b7280;">æ§‹é€ çš„å¯¾è©±ã‚¹ã‚³ã‚¢</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #dc2626;">${extraction.qualityPrediction.overallQuality}%</div>
                            <div style="font-size: 12px; color: #6b7280;">ç·åˆå“è³ª</div>
                        </div>
                    </div>
                </div>

                ${extraction.similarPatterns.length > 0 ? `
                    <div style="background: #f1f5f9; border: 1px solid #94a3b8; border-radius: 8px; padding: 16px; margin-top: 16px;">
                        <h3 style="color: #475569; margin-bottom: 12px;">ğŸ”— é¡ä¼¼ãƒ‘ã‚¿ãƒ¼ãƒ³</h3>
                        ${extraction.similarPatterns.map(pattern => `
                            <div style="font-size: 14px; color: #64748b; margin-bottom: 4px;">â€¢ ${pattern}</div>
                        `).join('')}
                    </div>
                ` : ''}
            `;

            // æ¦‚å¿µæŠ½å‡ºã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã—ã¦çµæœã‚’è¡¨ç¤º
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector('[onclick="switchTab(\'concepts\')"]').classList.add('active');
            document.getElementById('concepts-content').classList.add('active');

            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function getInnovationColor(level) {
            if (level >= 9) return '#dc2626'; // èµ¤ï¼ˆé©å‘½çš„ï¼‰
            if (level >= 7) return '#d97706'; // ã‚ªãƒ¬ãƒ³ã‚¸ï¼ˆé«˜é©æ–°ï¼‰
            if (level >= 5) return '#059669'; // ç·‘ï¼ˆä¸­é©æ–°ï¼‰
            return '#6b7280'; // ã‚°ãƒ¬ãƒ¼ï¼ˆåŸºæœ¬ï¼‰
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†æ©Ÿèƒ½
        let currentSessionData = null;

        /**
         * ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜
         */
        async function saveCurrentSession() {
            const rawLog = document.getElementById('rawLog').value.trim();
            const sessionContext = document.getElementById('sessionContext').value.trim();
            
            if (!rawLog) {
                showError('ä¿å­˜ã™ã‚‹å¯¾è©±ãƒ­ã‚°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const statusEl = document.getElementById('sessionStatus');
            statusEl.textContent = 'ğŸ’¾ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ä¸­...';
            statusEl.style.color = '#0ea5e9';

            try {
                const response = await fetch('/api/sessions/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: rawLog + (sessionContext ? '\n\n## ã‚»ãƒƒã‚·ãƒ§ãƒ³æ–‡è„ˆ\n' + sessionContext : ''),
                        options: {
                            customTags: ['web-session'],
                            autoAnalysis: true,
                            generateHandover: true
                        }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const session = result.session;
                    statusEl.innerHTML = `
                        âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜å®Œäº†ï¼<br>
                        ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«: <strong>${session.filename}</strong><br>
                        ğŸ“Š å“è³ª: <strong>${session.qualityScore}%</strong> 
                        (é©æ–°åº¦: ${session.innovationLevel}/10)
                    `;
                    statusEl.style.color = '#059669';
                    
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
                    currentSessionData = session;
                    
                    // è‡ªå‹•çš„ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚¿ãƒ–ã‚’è¡¨ç¤º
                    updateSessionManagementTab();
                    
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                statusEl.textContent = `âŒ ä¿å­˜å¤±æ•—: ${error.message}`;
                statusEl.style.color = '#dc2626';
                console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        /**
         * æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆå¼•ãç¶™ãä»˜ãï¼‰
         */
        async function startNewSession() {
            const statusEl = document.getElementById('sessionStatus');
            statusEl.textContent = 'ğŸ”— æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³æº–å‚™ä¸­...';
            statusEl.style.color = '#0ea5e9';

            try {
                const response = await fetch('/api/sessions/start-new', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        useHandover: true
                    })
                });

                const result = await response.json();

                if (result.success) {
                    if (result.hasHandover && result.startPrompt) {
                        // å¼•ãç¶™ããƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿãƒ­ã‚°ã‚¨ãƒªã‚¢ã«è¨­å®š
                        document.getElementById('rawLog').value = result.startPrompt;
                        
                        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ–‡è„ˆã‚¨ãƒªã‚¢ã«å¼•ãç¶™ãæƒ…å ±ã‚’è¨­å®š
                        const handover = result.handover;
                        document.getElementById('sessionContext').value = 
                            `å‰å›ã‚»ãƒƒã‚·ãƒ§ãƒ³å¼•ãç¶™ã (${handover.fromSessionId})\n` +
                            `ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${handover.keywords.join(', ')}\n` +
                            `æ¦‚è¦: ${handover.contextSummary}`;
                        
                        statusEl.innerHTML = `
                            âœ… å¼•ãç¶™ãã‚»ãƒƒã‚·ãƒ§ãƒ³æº–å‚™å®Œäº†ï¼<br>
                            ğŸ”‘ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: <strong>${handover.keywords.join(', ')}</strong><br>
                            ğŸ“ Claude/ChatGPTã«ä¸Šè¨˜ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦å¯¾è©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„
                        `;
                        statusEl.style.color = '#059669';
                        
                        // ç”Ÿãƒ­ã‚°ã‚¨ãƒªã‚¢ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                        document.getElementById('rawLog').scrollIntoView({ behavior: 'smooth' });
                        
                    } else {
                        // å¼•ãç¶™ããƒ‡ãƒ¼ã‚¿ãªã—
                        document.getElementById('rawLog').value = '';
                        document.getElementById('sessionContext').value = `æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ (${result.sessionId})`;
                        
                        statusEl.innerHTML = `
                            âœ… æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³æº–å‚™å®Œäº†ï¼<br>
                            ğŸ†” ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: <strong>${result.sessionId}</strong><br>
                            ğŸ’¬ æ–°ã—ã„å¯¾è©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„
                        `;
                        statusEl.style.color = '#059669';
                    }
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                statusEl.textContent = `âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹å¤±æ•—: ${error.message}`;
                statusEl.style.color = '#dc2626';
                console.error('æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        /**
         * æœ€æ–°å¼•ãç¶™ããƒ‡ãƒ¼ã‚¿ç¢ºèª
         */
        async function getLatestHandover() {
            const statusEl = document.getElementById('sessionStatus');
            statusEl.textContent = 'ğŸ”„ å¼•ãç¶™ããƒ‡ãƒ¼ã‚¿ç¢ºèªä¸­...';
            statusEl.style.color = '#0ea5e9';

            try {
                const response = await fetch('/api/sessions/handover/latest');
                const result = await response.json();

                if (result.success) {
                    if (result.hasHandover) {
                        const handover = result.handover;
                        statusEl.innerHTML = `
                            âœ… å¼•ãç¶™ããƒ‡ãƒ¼ã‚¿ã‚ã‚Šï¼<br>
                            ğŸ”‘ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: <strong>${handover.keywords.join(', ')}</strong><br>
                            ğŸ“Š å“è³ª: <strong>${handover.qualityScore}%</strong><br>
                            ğŸ“ ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹: ${handover.guidance.substring(0, 50)}...
                        `;
                        statusEl.style.color = '#059669';
                    } else {
                        statusEl.textContent = 'ğŸ“­ å¼•ãç¶™ãå¯èƒ½ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“';
                        statusEl.style.color = '#6b7280';
                    }
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                statusEl.textContent = `âŒ å¼•ãç¶™ãç¢ºèªå¤±æ•—: ${error.message}`;
                statusEl.style.color = '#dc2626';
                console.error('å¼•ãç¶™ãç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        /**
         * ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º
         */
        async function showSessionDashboard() {
            try {
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆã‚’å–å¾—
                const statsResponse = await fetch('/api/sessions/stats');
                const statsResult = await statsResponse.json();

                if (statsResult.success) {
                    await updateSessionManagementTab(statsResult.stats);
                    
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
                    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    document.querySelector('[onclick="switchTab(\'sessions\')"]').classList.add('active');
                    document.getElementById('sessions-content').classList.add('active');
                    
                    // çµæœã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
                    document.getElementById('results').style.display = 'block';
                    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                showError('ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        /**
         * ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚¿ãƒ–ã®å†…å®¹ã‚’æ›´æ–°
         */
        async function updateSessionManagementTab(stats = null) {
            const sessionsContent = document.getElementById('sessions-content');
            
            // çµ±è¨ˆæƒ…å ±ã‚’å–å¾—ï¼ˆæœªå–å¾—ã®å ´åˆï¼‰
            if (!stats) {
                try {
                    const response = await fetch('/api/sessions/stats');
                    const result = await response.json();
                    if (result.success) {
                        stats = result.stats;
                    }
                } catch (error) {
                    console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            if (stats) {
                sessionsContent.innerHTML = `
                    <div style="margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 12px;">
                        <h2 style="color: #0c4a6e; margin-bottom: 16px;">ğŸ’¾ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                            <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #0ea5e9;">${stats.totalSessions}</div>
                                <div style="font-size: 12px; color: #6b7280;">ç·ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #059669;">${stats.averageQuality}%</div>
                                <div style="font-size: 12px; color: #6b7280;">å¹³å‡å“è³ª</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #d97706;">${Object.keys(stats.phaseDistribution).length}</div>
                                <div style="font-size: 12px; color: #6b7280;">ãƒ•ã‚§ãƒ¼ã‚ºæ•°</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #7c3aed;">${Object.keys(stats.tagDistribution).length}</div>
                                <div style="font-size: 12px; color: #6b7280;">ã‚¿ã‚°æ•°</div>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
                        <!-- ãƒ•ã‚§ãƒ¼ã‚ºåˆ†å¸ƒ -->
                        <div style="background: #ecfdf5; border: 1px solid #10b981; border-radius: 8px; padding: 16px;">
                            <h3 style="color: #065f46; margin-bottom: 12px;">ğŸ“Š ãƒ•ã‚§ãƒ¼ã‚ºåˆ†å¸ƒ</h3>
                            ${Object.entries(stats.phaseDistribution).map(([phase, count]) => `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                                    <span><strong>${phase}</strong></span>
                                    <span style="color: #059669; font-weight: bold;">${count}å€‹</span>
                                </div>
                            `).join('')}
                        </div>

                        <!-- ã‚¿ã‚°åˆ†å¸ƒ -->
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px;">
                            <h3 style="color: #92400e; margin-bottom: 12px;">ğŸ·ï¸ ã‚¿ã‚°åˆ†å¸ƒ</h3>
                            ${Object.entries(stats.tagDistribution).slice(0, 10).map(([tag, count]) => `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 6px; padding: 6px; background: white; border-radius: 4px; font-size: 14px;">
                                    <span>${tag}</span>
                                    <span style="color: #d97706; font-weight: bold;">${count}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div style="background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 8px; padding: 16px;">
                        <h3 style="color: #334155; margin-bottom: 12px;">ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="startNewSession()">
                                ğŸ”— æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
                            </button>
                            <button class="btn btn-secondary" onclick="getLatestHandover()">
                                ğŸ”„ å¼•ãç¶™ãç¢ºèª
                            </button>
                            <button class="btn btn-secondary" onclick="searchSessions()">
                                ğŸ” ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œç´¢
                            </button>
                        </div>
                    </div>
                `;
            } else {
                sessionsContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <h3>ğŸ“­ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãªã—</h3>
                        <p>ã¾ã ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>å¯¾è©±ãƒ­ã‚°ã‚’ä¿å­˜ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†ã€‚</p>
                        <button class="btn btn-primary" onclick="saveCurrentSession()" style="margin-top: 16px;">
                            ğŸ’¾ æœ€åˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
                        </button>
                    </div>
                `;
            }
        }

        /**
         * ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œç´¢ï¼ˆç°¡æ˜“ç‰ˆï¼‰
         */
        async function searchSessions() {
            const keyword = prompt('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!keyword) return;

            try {
                const response = await fetch('/api/sessions/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keywords: [keyword]
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(`æ¤œç´¢çµæœ: ${result.count}ä»¶ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
                    console.log('æ¤œç´¢çµæœ:', result.sessions);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showError('ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('æ§‹é€ çš„å¯¾è©±ãƒ„ãƒ¼ãƒ«åˆæœŸåŒ–å®Œäº†');
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®åˆæœŸçŠ¶æ…‹ç¢ºèª
            getLatestHandover();
        });
    </script>
</body>
</html>